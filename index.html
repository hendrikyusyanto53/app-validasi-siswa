<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Validasi Data Siswa</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
    .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
    h1, h2 { color: #333; text-align: center; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input[type="text"], input[type="date"], select {
      width: calc(100% - 22px);
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      margin-top: 10px;
    }
    button:hover { background-color: #0056b3; }
    .form-group { margin-bottom: 15px; }
    #result { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
    .data-row { display: flex; flex-wrap: wrap; margin-bottom: 10px; }
    .data-label { font-weight: bold; width: 150px; flex-shrink: 0; }
    .data-value { flex-grow: 1; }
    .success-message { color: green; font-weight: bold; text-align: center; margin-top: 20px; }
    .error-message { color: red; font-weight: bold; text-align: center; margin-top: 20px; }
    #updateForm { display: none; }
    .actions { display: flex; justify-content: space-between; gap: 10px; }
    .actions button { width: 48%; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Validasi Data Siswa</h1>

    <div id="searchSection">
      <div class="form-group">
        <label for="studentName">Nama Lengkap:</label>
        <input type="text" id="studentName" placeholder="Masukkan Nama Lengkap Anda">
      </div>
      <button onclick="searchStudent()">Cari Data</button>
    </div>

    <div id="result">
      <h2>Hasil Pencarian</h2>
      <div id="studentData"></div>
      <div id="validationActions" style="display:none;">
        <p>Apakah data di atas sudah benar?</p>
        <div class="actions">
          <button onclick="confirmData()">Ya, Data Benar</button>
          <button onclick="showUpdateForm()">Tidak, Perbarui Data</button>
        </div>
      </div>
      <div id="message" class="success-message" style="display:none;"></div>
      <div id="errorMessage" class="error-message" style="display:none;"></div>
    </div>

    <div id="updateForm">
      <h2>Perbarui Data Siswa</h2>
      <form id="studentUpdateForm">
        <input type="hidden" id="updateId" name="ID">

        <div class="form-group">
          <label for="updateJurusan">Jurusan:</label>
          <input type="text" id="updateJurusan" name="Jurusan" readonly>
        </div>
        <div class="form-group">
          <label for="updateNamaLengkap">Nama Lengkap:</label>
          <input type="text" id="updateNamaLengkap" name="Nama Lengkap" >
        </div>
        <div class="form-group">
          <label for="updateNISN">NISN:</label>
          <input type="text" id="updateNISN" name="NISN">
        </div>
        <div class="form-group">
          <label for="updateTempatLahir">Tempat Lahir:</label>
          <input type="text" id="updateTempatLahir" name="Tempat Lahir">
        </div>
        <div class="form-group">
          <label for="updateTanggalLahir">Tanggal Lahir:</label>
          <input type="date" id="updateTanggalLahir" name="Tanggal Lahir">
        </div>
        <div class="form-group">
          <label for="updateJenisKelamin">Jenis Kelamin:</label>
          <select id="updateJenisKelamin" name="Jenis Kelamin">
            <option value="">Pilih</option>
            <option value="Laki-laki">Laki-laki</option>
            <option value="Perempuan">Perempuan</option>
          </select>
        </div>
        <div class="form-group">
          <label for="updateAgama">Agama:</label>
          <input type="text" id="updateAgama" name="Agama">
        </div>
        <div class="form-group">
          <label for="updateAsalSekolah">Asal Sekolah:</label>
          <input type="text" id="updateAsalSekolah" name="Asal Sekolah">
        </div>
        <div class="form-group">
          <label for="updateTahunLulus">Tahun Lulus:</label>
          <input type="text" id="updateTahunLulus" name="Tahun Lulus">
        </div>
        <div class="form-group">
          <label for="updateAlamat">Alamat:</label>
          <input type="text" id="updateAlamat" name="Alamat">
        </div>

        <button type="button" onclick="confirmUpdate()">Simpan Perubahan</button>
        <button type="button" onclick="cancelUpdate()" style="background-color: #6c757d;">Batal</button>
      </form>
    </div>

  </div>

  <script>
    var currentStudentData = null; // Menyimpan data siswa yang ditemukan

    function searchStudent() {
      var name = document.getElementById('studentName').value.trim();
      document.getElementById('message').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('validationActions').style.display = 'none';
      document.getElementById('studentData').innerHTML = '';
      document.getElementById('updateForm').style.display = 'none';

      if (name === '') {
        document.getElementById('errorMessage').textContent = 'Mohon masukkan Nama Lengkap.';
        document.getElementById('errorMessage').style.display = 'block';
        return;
      }

      // Tampilkan loading spinner atau pesan
      document.getElementById('message').textContent = 'Mencari data siswa...';
      document.getElementById('message').style.display = 'block';


      google.script.run
        .withSuccessHandler(displayStudentData)
        .withFailureHandler(showError)
        .searchStudentByName(name);
    }

    function displayStudentData(data) {
      document.getElementById('message').style.display = 'none'; // Sembunyikan pesan loading
      var studentDataDiv = document.getElementById('studentData');
      if (data) {
        currentStudentData = data; // Simpan data untuk update
        let html = '';
        const labels = {
            "No": "No", "Jurusan": "Jurusan", "ID": "ID", "Timestamp": "Timestamp",
            "Nama Lengkap": "Nama Lengkap", "NISN": "NISN", "Tempat Lahir": "Tempat Lahir",
            "Tanggal Lahir": "Tanggal Lahir", "Jenis Kelamin": "Jenis Kelamin", "Agama": "Agama",
            "Asal Sekolah": "Asal Sekolah", "Tahun Lulus": "Tahun Lulus", "Alamat": "Alamat",
            "Diperbarui Oleh": "Diperbarui Oleh", "Tanggal Diperbarui": "Tanggal Diperbarui",
            "Status Validasi": "Status Validasi"
        };

        for (const key in labels) {
            // Hanya tampilkan jika data ada dan bukan Timestamp (terlalu teknis untuk UI siswa)
            if (data.hasOwnProperty(key) && key !== "Timestamp") {
                html += `<div class="data-row"><span class="data-label">${labels[key]}:</span> <span class="data-value">${data[key]}</span></div>`;
            }
        }

        studentDataDiv.innerHTML = html;
        document.getElementById('validationActions').style.display = 'block';
      } else {
        studentDataDiv.innerHTML = '<p>Data siswa tidak ditemukan. Mohon periksa kembali nama yang Anda masukkan.</p>';
      }
    }

    function showError(error) {
      document.getElementById('message').style.display = 'none'; // Sembunyikan pesan loading
      document.getElementById('errorMessage').textContent = 'Terjadi kesalahan: ' + error.message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('validationActions').style.display = 'none'; // Sembunyikan aksi jika ada error
      document.getElementById('studentData').innerHTML = ''; // Kosongkan tampilan data
    }

    function confirmData() {
      if (!currentStudentData || !currentStudentData["ID"]) {
          showError(new Error("Tidak ada data siswa atau ID siswa tidak ditemukan untuk validasi."));
          return;
      }

      // Tampilkan loading atau pesan saat proses validasi
      document.getElementById('message').textContent = 'Merekam status validasi...';
      document.getElementById('message').style.display = 'block';
      document.getElementById('validationActions').style.display = 'none'; // Sembunyikan tombol aksi

      google.script.run
        .withSuccessHandler(function(status) {
            if (status === 'success') {
                document.getElementById('message').textContent = 'Data Anda telah divalidasi sebagai benar. Terima kasih.';
                document.getElementById('message').style.display = 'block';
                document.getElementById('studentData').innerHTML = '';
                document.getElementById('studentName').value = '';
                currentStudentData = null; // Reset data siswa setelah validasi
            } else {
                showError(new Error("Gagal mencatat status validasi."));
            }
        })
        .withFailureHandler(showError)
        .recordValidation(currentStudentData["ID"]);
    }

    function showUpdateForm() {
      if (!currentStudentData) return;

      document.getElementById('searchSection').style.display = 'none';
      document.getElementById('result').style.display = 'none';
      document.getElementById('updateForm').style.display = 'block';
      document.getElementById('message').style.display = 'none'; // Sembunyikan pesan sukses/error lain

      // Isi formulir update dengan data yang ada
      document.getElementById('updateId').value = currentStudentData["ID"];
      document.getElementById('updateJurusan').value = currentStudentData["Jurusan"];
      document.getElementById('updateNamaLengkap').value = currentStudentData["Nama Lengkap"];
      document.getElementById('updateNISN').value = currentStudentData["NISN"];
      document.getElementById('updateTempatLahir').value = currentStudentData["Tempat Lahir"];
      document.getElementById('updateTanggalLahir').value = currentStudentData["Tanggal Lahir"];
      document.getElementById('updateJenisKelamin').value = currentStudentData["Jenis Kelamin"];
      document.getElementById('updateAgama').value = currentStudentData["Agama"];
      document.getElementById('updateAsalSekolah').value = currentStudentData["Asal Sekolah"];
      document.getElementById('updateTahunLulus').value = currentStudentData["Tahun Lulus"];
      document.getElementById('updateAlamat').value = currentStudentData["Alamat"];
    }

    function confirmUpdate() {
        if (confirm("Apakah Anda yakin ingin menyimpan perubahan data ini?")) {
            submitUpdate();
        }
    }

    function submitUpdate() {
      var formData = {};
      var formElements = document.getElementById('studentUpdateForm').elements;
      for (var i = 0; i < formElements.length; i++) {
        var element = formElements[i];
        if (element.name) {
          formData[element.name] = element.value;
        }
      }

      document.getElementById('message').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';

      // Tampilkan loading atau pesan saat proses update
      document.getElementById('message').textContent = 'Menyimpan perubahan data...';
      document.getElementById('message').style.display = 'block';


      google.script.run
        .withSuccessHandler(showUpdateSuccess)
        .withFailureHandler(showError)
        .updateStudentData(formData);
    }

    function showUpdateSuccess(status) {
      document.getElementById('message').style.display = 'none'; // Sembunyikan pesan loading
      if (status === 'success') {
        document.getElementById('updateForm').style.display = 'none';
        document.getElementById('searchSection').style.display = 'block';
        document.getElementById('result').style.display = 'block';
        document.getElementById('message').textContent = 'Data Anda berhasil diperbarui. Terima kasih.';
        document.getElementById('message').style.display = 'block';
        document.getElementById('studentData').innerHTML = '';
        document.getElementById('studentName').value = '';
        currentStudentData = null; // Reset data siswa setelah update
      } else {
        document.getElementById('errorMessage').textContent = 'Gagal memperbarui data.';
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    function cancelUpdate() {
      document.getElementById('updateForm').style.display = 'none';
      document.getElementById('searchSection').style.display = 'block';
      document.getElementById('result').style.display = 'block';
      document.getElementById('message').style.display = 'none'; // Sembunyikan pesan apapun saat batal
      document.getElementById('errorMessage').style.display = 'none'; // Sembunyikan pesan apapun saat batal

      if (currentStudentData) {
          displayStudentData(currentStudentData); // Tampilkan kembali data yang dicari sebelumnya
          document.getElementById('validationActions').style.display = 'block';
      } else {
          document.getElementById('studentData').innerHTML = '';
          document.getElementById('validationActions').style.display = 'none';
      }
    }
  </script>
</body>
</html>
